<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIS Airlines - Znalezione loty</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" href="assets/images/favicon.ico" type="image/x-icon">
</head>
<body>
    <header class="header">
        <div class="top-bar">
            <div class="container">
                <div class="top-bar-left">
                    <a href="index.html" class="logo-link">
                        <img src="assets/images/logo.png" alt="VIS Airlines Logo" class="logo">
                    </a>
                    <nav class="main-nav">
                        <ul>
                            <li><a href="index.html" class="active">Zarezerwuj lot</a></li>
                            <li><a href="#">Odpraw się</a></li>
                            <li><a href="#">Zarządzaj rezerwacją</a></li>
                        </ul>
                    </nav>
                </div>
                <div class="top-bar-right">
                    <div class="language-selector">
                        <img src="assets/images/flag_pl.png" alt="Język" class="icon">
                        <span>Język</span>
                        <select>
                            <option value="pl">Polski</option>
                            <option value="en">English</option>
                        </select>
                    </div>
                    <div class="currency-selector">
                        <img src="assets/images/icon_currency.png" alt="Waluta" class="icon">
                        <span>Waluta</span>
                        <select>
                            <option value="PLN">PLN</option>
                            <option value="USD">USD</option>
                            <option value="EUR">EUR</option>
                        </select>
                    </div>
                    <a href="#" class="account-link">
                        <img src="assets/images/icon_account.png" alt="Konto" class="icon">
                        <span>Konto</span>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <main class="main-content">
        <section class="search-results-summary">
            <div class="container">
                <div class="summary-top-bar">
                    <p>Wybrane kryteria:</p>
                    <p id="topBarRoute">Trasa: ---</p>
                    <p id="topBarDates">Daty: ---</p>
                    <p id="topBarClass">Klasa: ---</p>
                    <p id="topBarPassengers">Pasażerowie: ---</p>
                    <button id="editSearchBtn" class="edit-search-btn">Edytuj wyszukiwanie</button>
                </div>
            </div>
        </section>

        <section class="flights-display">
            <div class="container">
                <div class="flight-section">
                    <h2 id="departureFlightHeading">Loty wylotowe</h2>
                    <div class="date-slider" id="departureDateSlider">
                        </div>
                    <div class="flight-listings" id="departure-flight-listings">
                        </div>
                    <p class="message-box error-message hidden" id="noDepartureFlightsMessage">Brak dostępnych lotów w wybranej dacie.</p>
                    <p class="message-box error-message hidden" id="departureClassRestrictionMessage">Wybrana klasa podróży nie jest obsługiwana dla tej trasy.</p>
                </div>

                <div class="flight-section hidden" id="returnFlightsSection">
                    <h2 id="returnFlightHeading">Loty powrotne</h2>
                    <div class="date-slider" id="returnDateSlider">
                        </div>
                    <div class="flight-listings" id="return-flight-listings">
                        </div>
                    <p class="message-box error-message hidden" id="noReturnFlightsMessage">Brak dostępnych lotów w wybranej dacie.</p>
                    <p class="message-box error-message hidden" id="returnClassRestrictionMessage">Wybrana klasa podróży nie jest obsługiwana dla tej trasy.</p>
                </div>
            </div>
        </section>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 VIS Airlines. Wszystkie prawa zastrzeżone.</p>
        </div>
    </footer>

    <div id="editSearchModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Edytuj wyszukiwanie</h2>
            <form id="editFlightSearchForm">
                <div class="form-group">
                    <label for="editDepartureCity">Miasto wylotu:</label>
                    <select id="editDepartureCity" name="from" required>
                        <option value="Gdańsk (GDN)">Gdańsk (GDN)</option>
                        <option value="Warszawa (WAW)">Warszawa (WAW)</option>
                        <option value="Kraków (KRK)">Kraków (KRK)</option>
                        <option value="Wrocław (WRO)">Wrocław (WRO)</option>
                        <option value="Poznań (POZ)">Poznań (POZ)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editArrivalCity">Miasto przylotu:</label>
                    <select id="editArrivalCity" name="to" required>
                        <option value="Warszawa (WAW)">Warszawa (WAW)</option>
                        <option value="Gdańsk (GDN)">Gdańsk (GDN)</option>
                        <option value="Kraków (KRK)">Kraków (KRK)</option>
                        <option value="Wrocław (WRO)">Wrocław (WRO)</option>
                        <option value="Poznań (POZ)">Poznań (POZ)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editDepartureDate">Data wylotu:</label>
                    <input type="date" id="editDepartureDate" name="date_from" required>
                </div>
                <div class="form-group">
                    <label for="editReturnDate">Data powrotu (opcjonalnie):</label>
                    <input type="date" id="editReturnDate" name="date_to">
                </div>
                <div class="form-group class-passengers-group">
                    <button type="button" id="editClassPassengersBtn" class="class-passengers-button">
                        <span id="editSelectedClass">LOT Economy Class</span>, <span id="editSelectedPassengers">1 Pasażer</span>
                    </button>
                </div>
                <button type="submit" class="search-flights-btn">Zaktualizuj wyszukiwanie</button>
            </form>
        </div>
    </div>

    <div id="editClassPassengersModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Wybierz klasę podróży</h2>
            <div class="class-options">
                <button type="button" class="class-option selected" data-class="Economy">LOT Economy Class</button>
                <button type="button" class="class-option" data-class="Premium Economy">LOT Premium Economy</button>
                <button type="button" class="class-option" data-class="Business">LOT Business Class</button>
            </div>

            <h2>Dodaj pasażerów</h2>
            <p class="small-text">Sprawdź wiek pasażerów w dniu wylotu</p>
            <div class="passenger-types">
                <div class="passenger-type">
                    <label>Dorośli <span class="small-text">16+ lat</span> <span class="info-icon" title="Osoby w wieku 16 lat lub starsze."><img src="assets/images/icon_info.png" alt="Info"></span></label>
                    <div class="quantity-control">
                        <button type="button" class="minus-btn">-</button>
                        <input type="number" value="1" min="1" id="editAdults" data-type="adults">
                        <button type="button" class="plus-btn">+</button>
                    </div>
                </div>
                <div class="passenger-type">
                    <label>Nastolatkowie <span class="small-text">12-15 lat</span> <span class="info-icon" title="Osoby w wieku 12-15 lat."><img src="assets/images/icon_info.png" alt="Info"></span></label>
                    <div class="quantity-control">
                        <button type="button" class="minus-btn">-</button>
                        <input type="number" value="0" min="0" id="editTeenagers" data-type="teenagers">
                        <button type="button" class="plus-btn">+</button>
                    </div>
                </div>
                <div class="passenger-type">
                    <label>Dzieci <span class="small-text">2-11 lat</span> <span class="info-icon" title="Osoby w wieku 2-11 lat."><img src="assets/images/icon_info.png" alt="Info"></span></label>
                    <div class="quantity-control">
                        <button type="button" class="minus-btn">-</button>
                        <input type="number" value="0" min="0" id="editChildren" data-type="children">
                        <button type="button" class="plus-btn">+</button>
                    </div>
                </div>
                <div class="passenger-type">
                    <label>Niemowlęta (z miejscem) <span class="small-text">0-24 miesiące</span> <span class="info-icon" title="Dzieci do 24 miesiąca życia, które będą miały swoje miejsce."><img src="assets/images/icon_info.png" alt="Info"></span></label>
                    <div class="quantity-control">
                        <button type="button" class="minus-btn">-</button>
                        <input type="number" value="0" min="0" id="editInfantsSeat" data-type="infantsSeat">
                        <button type="button" class="plus-btn">+</button>
                    </div>
                </div>
                <div class="passenger-type">
                    <label>Niemowlęta <span class="small-text">0-24 miesiące</span> <span class="info-icon" title="Dzieci do 24 miesiąca życia, które będą podróżować na kolanach dorosłego."> <img src="assets/images/icon_info.png" alt="Info"></span></label>
                    <div class="quantity-control">
                        <button type="button" class="minus-btn">-</button>
                        <input type="number" value="0" min="0" id="editInfantsLap" data-type="infantsLap">
                        <button type="button" class="plus-btn">+</button>
                    </div>
                </div>
            </div>
            <button type="button" id="editConfirmPassengersBtn">Potwierdź</button>
        </div>
    </div>


    <script>
        // Dane symulowanych lotów
        const simulatedFlights = [
            { // Lot Gdańsk -> Warszawa
                from: "Gdańsk",
                to: "Warszawa",
                flightNumber: "VIS101",
                departureTime: "05:00",
                arrivalTime: "05:55",
                duration: "0h 55min",
                basePrice: 199,
                restrictedClasses: [], // Brak ograniczeń dla tego lotu
                operator: "VIS Airlines",
                dailyPrices: { // Ceny dla przykładowych dat (DD.MM.RRRR)
                    "13.07.2025": 199, "14.07.2025": 210, "15.07.2025": 205, "16.07.2025": 220, "17.07.2025": 195, "18.07.2025": 230, "19.07.2025": 200,
                    "20.07.2025": 199, "21.07.2025": 210, "22.07.2025": 205, "23.07.2025": 220, "24.07.2025": 195, "25.07.2025": 230, "26.07.2025": 200,
                    "27.07.2025": 199, "28.07.2025": 210, "29.07.2025": 205, "30.07.2025": 220, "31.07.2025": 195, "01.08.2025": 230, "02.08.2025": 200,
                }
            },
            { // Lot Warszawa -> Gdańsk
                from: "Warszawa",
                to: "Gdańsk",
                flightNumber: "VIS102",
                departureTime: "06:30",
                arrivalTime: "07:25",
                duration: "0h 55min",
                basePrice: 210,
                restrictedClasses: [],
                operator: "VIS Airlines",
                dailyPrices: {
                    "13.07.2025": 210, "14.07.2025": 200, "15.07.2025": 215, "16.07.2025": 225, "17.07.2025": 205, "18.07.2025": 235, "19.07.2025": 210,
                    "20.07.2025": 210, "21.07.2025": 200, "22.07.2025": 215, "23.07.2025": 225, "24.07.2025": 205, "25.07.2025": 235, "26.07.2025": 210,
                    "27.07.2025": 210, "28.07.2025": 200, "29.07.2025": 215, "30.07.2025": 225, "31.07.2025": 205, "01.08.2025": 235, "02.08.2025": 210,
                }
            },
            { // Lot Gdańsk -> Warszawa (inny lot, inna godzina)
                from: "Gdańsk",
                to: "Warszawa",
                flightNumber: "VIS103",
                departureTime: "12:00",
                arrivalTime: "12:55",
                duration: "0h 55min",
                basePrice: 250,
                restrictedClasses: ['Premium Economy'], // Przykładowe ograniczenie
                operator: "VIS Airlines",
                dailyPrices: {
                    "13.07.2025": 250, "14.07.2025": 260, "15.07.2025": 245, "16.07.2025": 270, "17.07.2025": 240, "18.07.2025": 280, "19.07.2025": 255,
                }
            },
            { // Lot Warszawa -> Gdańsk (inny lot, inna godzina)
                from: "Warszawa",
                to: "Gdańsk",
                flightNumber: "VIS104",
                departureTime: "18:00",
                arrivalTime: "18:55",
                duration: "0h 55min",
                basePrice: 240,
                restrictedClasses: ['Business'], // Przykładowe ograniczenie
                operator: "VIS Airlines",
                dailyPrices: {
                    "13.07.2025": 240, "14.07.2025": 230, "15.07.2025": 250, "16.07.2025": 260, "17.07.2025": 235, "18.07.2025": 270, "19.07.2025": 245,
                }
            }
            // Możesz dodać więcej lotów tutaj
        ];

        // --- Zmienne globalne do przechowywania stanu wyszukiwania ---
        let currentDepartureCity;
        let currentArrivalCity;
        let currentDepartureDate; // Format DD.MM.RRRR
        let currentReturnDate = null; // Format DD.MM.RRRR
        let currentSelectedClass = "Economy";
        let currentAdults = 1;
        let currentTeenagers = 0;
        let currentChildren = 0;
        let currentInfantsSeat = 0;
        let currentInfantsLap = 0;


        // --- Elementy DOM ---
        const topBarRoute = document.getElementById('topBarRoute');
        const topBarDates = document.getElementById('topBarDates');
        const topBarClass = document.getElementById('topBarClass');
        const topBarPassengers = document.getElementById('topBarPassengers');

        const departureFlightHeading = document.getElementById('departureFlightHeading');
        const returnFlightHeading = document.getElementById('returnFlightHeading');

        const departureDateList = document.getElementById('departureDateSlider');
        const returnDateList = document.getElementById('returnDateSlider');
        const departureFlightListings = document.getElementById('departure-flight-listings');
        const returnFlightListings = document.getElementById('return-flight-listings');

        const noDepartureFlightsMessage = document.getElementById('noDepartureFlightsMessage');
        const noReturnFlightsMessage = document.getElementById('noReturnFlightsMessage');
        const departureClassRestrictionMessage = document.getElementById('departureClassRestrictionMessage');
        const returnClassRestrictionMessage = document.getElementById('returnClassRestrictionMessage');

        const returnFlightsSection = document.getElementById('returnFlightsSection');

        // --- Modale i ich elementy (do edycji wyszukiwania) ---
        const editSearchBtn = document.getElementById('editSearchBtn');
        const editSearchModal = document.getElementById('editSearchModal');
        const editSearchModalCloseBtn = editSearchModal.querySelector('.close-button');
        const editFlightSearchForm = document.getElementById('editFlightSearchForm');

        const editDepartureCitySelect = document.getElementById('editDepartureCity');
        const editArrivalCitySelect = document.getElementById('editArrivalCity');
        const editDepartureDateInput = document.getElementById('editDepartureDate');
        const editReturnDateInput = document.getElementById('editReturnDate');

        const editClassPassengersBtn = document.getElementById('editClassPassengersBtn');
        const editSelectedClassSpan = document.getElementById('editSelectedClass');
        const editSelectedPassengersSpan = document.getElementById('editSelectedPassengers');

        const editClassPassengersModal = document.getElementById('editClassPassengersModal');
        const editClassPassengersModalCloseBtn = editClassPassengersModal.querySelector('.close-button');
        const editConfirmPassengersBtn = document.getElementById('editConfirmPassengersBtn');

        let currentEditClass = "Economy"; // Domyślna wartość dla modala edycji
        let currentEditAdults = 1;
        let currentEditTeenagers = 0;
        let currentEditChildren = 0;
        let currentEditInfantsSeat = 0;
        let currentEditInfantsLap = 0;


        // --- Funkcje pomocnicze ---

        // Funkcja pomocnicza do wyodrębniania nazwy miasta z formatu "Miasto (KOD)"
        function extractCityName(cityString) {
            if (!cityString) return '';
            const match = cityString.match(/^(.*?)\s*\(.+\)$/);
            return match ? match[1].trim() : cityString.trim();
        }

        // Funkcja do formatowania daty na DD.MM.RRRR
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString); // dateString w formacie YYYY-MM-DD
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}.${month}.${year}`;
        }

        // Funkcja do konwersji daty z DD.MM.RRRR na YYYY-MM-DD (dla input type="date")
        function convertDateToInputFormat(dateString) {
            if (!dateString) return '';
            const parts = dateString.split('.');
            return `${parts[2]}-${parts[1]}-${parts[0]}`;
        }

        // Funkcja do pobierania parametrów z URL
        function getQueryParams() {
            const params = {};
            window.location.search.substring(1).split('&').forEach(param => {
                const parts = param.split('=');
                params[decodeURIComponent(parts[0])] = decodeURIComponent(parts[1] || '');
            });
            return params;
        }

        // Funkcja do aktualizacji wyświetlanej liczby pasażerów i klasy
        function updatePassengersAndClassDisplay(selectedClassSpan, selectedPassengersSpan, adults, teenagers, children, infantsSeat, infantsLap, selectedClass) {
            const totalPassengers = adults + teenagers + children + infantsSeat + infantsLap;
            selectedClassSpan.textContent = `LOT ${selectedClass} Class`;
            let passengersText = `${totalPassengers} pasażer`;
            if (totalPassengers > 1 && totalPassengers < 5) {
                passengersText = `${totalPassengers} pasażerów`;
            } else if (totalPassengers >= 5 || totalPassengers === 0) { // Dla 0 i od 5 w górę, użyj "pasażerów"
                 passengersText = `${totalPassengers} pasażerów`;
            }
            selectedPassengersSpan.textContent = passengersText;
        }

        // Funkcja do otwierania modala
        function openModal(modalElement) {
            modalElement.style.display = 'block';
        }

        // Funkcja do zamykania modala
        function closeModal(modalElement) {
            modalElement.style.display = 'none';
        }

        // Funkcja do setupu modali edycji wyszukiwania (używana zarówno na index.html jak i flights.html)
        function setupEditSearchModals() {
            // Obsługa modala edycji wyszukiwania
            editSearchBtn.addEventListener('click', () => {
                // Ustaw wartości w formularzu edycji na aktualne
                editDepartureCitySelect.value = `${currentDepartureCity} (${currentDepartureCity.substring(0,3).toUpperCase()})`;
                editArrivalCitySelect.value = `${currentArrivalCity} (${currentArrivalCity.substring(0,3).toUpperCase()})`;
                editDepartureDateInput.value = convertDateToInputFormat(currentDepartureDate);
                editReturnDateInput.value = currentReturnDate ? convertDateToInputFormat(currentReturnDate) : '';

                // Ustaw stan dla modala pasażerów w edycji
                currentEditClass = currentSelectedClass;
                currentEditAdults = currentAdults;
                currentEditTeenagers = currentTeenagers;
                currentEditChildren = currentChildren;
                currentEditInfantsSeat = currentInfantsSeat;
                currentEditInfantsLap = currentInfantsLap;

                updatePassengersAndClassDisplay(
                    editSelectedClassSpan,
                    editSelectedPassengersSpan,
                    currentEditAdults, currentEditTeenagers, currentEditChildren, currentEditInfantsSeat, currentEditInfantsLap,
                    currentEditClass
                );

                openModal(editSearchModal);
            });

            editSearchModalCloseBtn.addEventListener('click', () => {
                closeModal(editSearchModal);
            });

            // Obsługa otwierania modala wyboru klasy/pasażerów z poziomu edycji
            editClassPassengersBtn.addEventListener('click', () => {
                // Ustawiamy wartości inputów w modal_edit na aktualny stan
                document.getElementById('editAdults').value = currentEditAdults;
                document.getElementById('editTeenagers').value = currentEditTeenagers;
                document.getElementById('editChildren').value = currentEditChildren;
                document.getElementById('editInfantsSeat').value = currentEditInfantsSeat;
                document.getElementById('editInfantsLap').value = currentEditInfantsLap;

                // Ustawiamy zaznaczoną klasę
                editClassPassengersModal.querySelectorAll('.class-option').forEach(btn => {
                    if (btn.dataset.class === currentEditClass) {
                        btn.classList.add('selected');
                    } else {
                        btn.classList.remove('selected');
                    }
                });

                openModal(editClassPassengersModal);
            });

            editClassPassengersModalCloseBtn.addEventListener('click', () => {
                closeModal(editClassPassengersModal);
            });

            editClassPassengersModal.querySelectorAll('.class-option').forEach(button => {
                button.addEventListener('click', () => {
                    editClassPassengersModal.querySelectorAll('.class-option').forEach(btn => btn.classList.remove('selected'));
                    button.classList.add('selected');
                    currentEditClass = button.dataset.class;
                });
            });

            editClassPassengersModal.querySelectorAll('.quantity-control button').forEach(button => {
                button.addEventListener('click', (event) => {
                    const input = event.target.closest('.quantity-control').querySelector('input');
                    let value = parseInt(input.value);
                    const type = input.dataset.type;

                    if (event.target.classList.contains('minus-btn')) {
                        value = Math.max(input.min, value - 1);
                    } else {
                        value = value + 1;
                    }
                    input.value = value;

                    // Zaktualizuj tymczasowe zmienne edycji
                    switch (type) {
                        case 'adults': currentEditAdults = value; break;
                        case 'teenagers': currentEditTeenagers = value; break;
                        case 'children': currentEditChildren = value; break;
                        case 'infantsSeat': currentEditInfantsSeat = value; break;
                        case 'infantsLap': currentEditInfantsLap = value; break;
                    }

                    // Logika ograniczenia niemowląt na kolanach do liczby dorosłych
                    if (type === 'adults' || type === 'infantsLap') {
                        const infantsLapInput = document.getElementById('editInfantsLap');
                        if (currentEditInfantsLap > currentEditAdults) {
                            currentEditInfantsLap = currentEditAdults;
                            infantsLapInput.value = currentEditInfantsLap;
                        }
                    }
                });
            });

            editConfirmPassengersBtn.addEventListener('click', () => {
                // Po potwierdzeniu z modala edycji pasażerów, zaktualizuj wyświetlanie w przycisku edycji
                updatePassengersAndClassDisplay(
                    editSelectedClassSpan,
                    editSelectedPassengersSpan,
                    currentEditAdults, currentEditTeenagers, currentEditChildren, currentEditInfantsSeat, currentEditInfantsLap,
                    currentEditClass
                );
                closeModal(editClassPassengersModal);
            });

            // Obsługa formularza edycji wyszukiwania
            editFlightSearchForm.addEventListener('submit', (event) => {
                event.preventDefault();

                // Zaktualizuj globalne zmienne wyszukiwania danymi z edycji
                currentDepartureCity = extractCityName(editDepartureCitySelect.value);
                currentArrivalCity = extractCityName(editArrivalCitySelect.value);
                currentDepartureDate = formatDate(editDepartureDateInput.value);
                currentReturnDate = editReturnDateInput.value ? formatDate(editReturnDateInput.value) : null;
                currentSelectedClass = currentEditClass;
                currentAdults = currentEditAdults;
                currentTeenagers = currentEditTeenagers;
                currentChildren = currentEditChildren;
                currentInfantsSeat = currentEditInfantsSeat;
                currentInfantsLap = currentEditInfantsLap;

                // Zaktualizuj wyświetlanie na górnym pasku podsumowania
                updateSummaryDisplay();

                // Zaktualizuj nagłówki sekcji lotów
                departureFlightHeading.textContent = `Loty z ${currentDepartureCity} (${currentDepartureCity.substring(0, 3).toUpperCase()}) do ${currentArrivalCity} (${currentArrivalCity.substring(0, 3).toUpperCase()})`;
                if (currentReturnDate) {
                    returnFlightsSection.classList.remove('hidden');
                    returnFlightHeading.textContent = `Loty z ${currentArrivalCity} (${currentArrivalCity.substring(0, 3).toUpperCase()}) do ${currentDepartureCity} (${currentDepartureCity.substring(0, 3).toUpperCase()})`;
                } else {
                    returnFlightsSection.classList.add('hidden');
                }


                // Przeładuj loty dla nowych kryteriów
                renderFlights(convertDateToInputFormat(currentDepartureDate), 'departure', departureFlightListings, noDepartureFlightsMessage, departureClassRestrictionMessage);
                if (currentReturnDate) {
                    renderFlights(convertDateToInputFormat(currentReturnDate), 'return', returnFlightListings, noReturnFlightsMessage, returnClassRestrictionMessage);
                }

                closeModal(editSearchModal);
            });

            // Zamykanie modali po kliknięciu poza nimi
            window.addEventListener('click', (event) => {
                if (event.target === editSearchModal) {
                    closeModal(editSearchModal);
                }
                if (event.target === editClassPassengersModal) {
                    closeModal(editClassPassengersModal);
                }
            });
        }


        // Funkcja do renderowania slidera dat
        function renderDateSlider(startDate, containerElement, direction, onDateSelect) {
            containerElement.innerHTML = ''; // Wyczyść poprzednie daty

            const today = new Date();
            today.setHours(0, 0, 0, 0); // Zresetuj czas, aby porównywać tylko daty

            // Ustaw datę początkową na dzisiejszą, jeśli startDate jest wcześniejsza niż dzisiejsza
            // lub ustaw ją tak, aby zawsze pokazywać datę bieżącego wyszukiwania, jeśli istnieje
            let startRenderingDate = new Date(startDate);
            // Ensure the startRenderingDate is not before today for display purposes,
            // unless the original search date *is* in the past.
            if (startRenderingDate < today && formatDate(startRenderingDate.toISOString().slice(0,10)) !== formatDate(today.toISOString().slice(0,10))) {
                 startRenderingDate = new Date(today);
            }


            const dates = [];
            for (let i = -3; i <= 3; i++) { // Generuj 7 dni (-3 do +3 od daty początkowej)
                const date = new Date(startRenderingDate);
                date.setDate(startRenderingDate.getDate() + i);
                dates.push(date);
            }

            dates.forEach(date => {
                const dateStr = date.toISOString().slice(0, 10); // Format YYYY-MM-DD
                const dayOfMonth = date.getDate();
                const dayOfWeek = new Intl.DateTimeFormat('pl-PL', { weekday: 'short' }).format(date);
                const isSelected = formatDate(dateStr) === (direction === 'departure' ? currentDepartureDate : currentReturnDate);

                const dateItem = document.createElement('div');
                dateItem.classList.add('date-item');
                if (isSelected) {
                    dateItem.classList.add('selected');
                }
                if (date < today && !isSelected) { // Nie oznaczaj jako "minione", jeśli to aktualnie wybrana data, która jest w przeszłości
                     dateItem.classList.add('past-date');
                }

                dateItem.dataset.date = dateStr;
                dateItem.innerHTML = `
                    <span class="day-of-week">${dayOfWeek.charAt(0).toUpperCase() + dayOfWeek.slice(1).replace('.', '')}</span>
                    <span class="day-of-month">${dayOfMonth}</span>
                `;
                containerElement.appendChild(dateItem);

                dateItem.addEventListener('click', () => {
                    containerElement.querySelectorAll('.date-item').forEach(item => item.classList.remove('selected'));
                    dateItem.classList.add('selected');
                    onDateSelect(dateStr); // Wywołaj callback z wybraną datą
                });
            });
        }


        // Funkcja do renderowania lotów
        function renderFlights(dateStr, direction, containerElement, noFlightsMsgElement, classRestrictionMsgElement) {
            containerElement.innerHTML = ''; // Wyczyść poprzednie loty
            noFlightsMsgElement.classList.add('hidden');
            classRestrictionMsgElement.classList.add('hidden');

            const targetFrom = direction === 'departure' ? currentDepartureCity : currentArrivalCity;
            const targetTo = direction === 'departure' ? currentArrivalCity : currentDepartureCity;
            const selectedDateFormatted = formatDate(dateStr); // Konwertuj YYYY-MM-DD na DD.MM.RRRR

            console.log(`Rendering flights for: ${targetFrom} to ${targetTo} on ${selectedDateFormatted} (Direction: ${direction})`); // Debugowanie
            console.log("Current selected class:", currentSelectedClass); // Debugowanie

            const foundFlights = simulatedFlights.filter(flight => {
                const matchesRoute = flight.from === targetFrom && flight.to === targetTo;
                const hasPriceForDate = flight.dailyPrices && flight.dailyPrices[selectedDateFormatted] !== undefined;

                console.log(`  Checking flight ${flight.flightNumber}: ${flight.from} -> ${flight.to}, Date: ${selectedDateFormatted}, Price available: ${hasPriceForDate}`); // Debugowanie
                return matchesRoute && hasPriceForDate;
            });

            console.log("Found flights:", foundFlights); // Debugowanie

            if (foundFlights.length === 0) {
                noFlightsMsgElement.classList.remove('hidden');
                return;
            }

            let foundFlightsForClass = false;
            foundFlights.forEach(flight => {
                // Sprawdź, czy wybrana klasa jest dozwolona dla tego lotu
                const isClassAllowed = !flight.restrictedClasses.includes(currentSelectedClass);

                if (isClassAllowed) {
                    foundFlightsForClass = true; // Znaleziono przynajmniej jeden lot dla wybranej klasy
                    const price = flight.dailyPrices[selectedDateFormatted];

                    const flightItem = document.createElement('div');
                    flightItem.classList.add('flight-item');
                    flightItem.innerHTML = `
                        <div class="flight-details">
                            <div class="flight-times">
                                <span class="time">${flight.departureTime}</span>
                                <span class="city">${flight.from}</span>
                            </div>
                            <div class="flight-duration">
                                <span class="duration">${flight.duration}</span>
                                <span class="line">---</span>
                                <span class="operator">${flight.operator}</span>
                            </div>
                            <div class="flight-times">
                                <span class="time">${flight.arrivalTime}</span>
                                <span class="city">${flight.to}</span>
                            </div>
                        </div>
                        <div class="flight-price">
                            <span class="price">${price.toFixed(2)} PLN</span>
                            <button class="select-flight-btn">Wybierz</button>
                        </div>
                    `;
                    containerElement.appendChild(flightItem);
                }
            });

            // Jeśli po przefiltrowaniu pod kątem klasy nie ma żadnych lotów, wyświetl odpowiedni komunikat
            if (!foundFlightsForClass && foundFlights.length > 0) { // Tylko jeśli są loty, ale żaden nie pasuje do klasy
                classRestrictionMsgElement.classList.remove('hidden');
            } else if (!foundFlightsForClass && foundFlights.length === 0) { // Ten przypadek jest już obsłużony wyżej
                 noFlightsMsgElement.classList.remove('hidden');
            }
        }


        // Funkcja aktualizująca wyświetlanie podsumowania wyszukiwania
        function updateSummaryDisplay() {
            topBarRoute.textContent = `Trasa: ${currentDepartureCity} (${currentDepartureCity.substring(0, 3).toUpperCase()}) → ${currentArrivalCity} (${currentArrivalCity.substring(0, 3).toUpperCase()})`;
            topBarDates.textContent = `Daty: ${currentDepartureDate}${currentReturnDate ? ' → ' + currentReturnDate : ''}`;
            topBarClass.textContent = `Klasa: LOT ${currentSelectedClass} Class`;
            const totalPassengers = currentAdults + currentTeenagers + currentChildren + currentInfantsSeat + currentInfantsLap;
            let passengersText = `${totalPassengers} pasażer`;
            if (totalPassengers > 1 && totalPassengers < 5) {
                passengersText = `${totalPassengers} pasażerów`;
            } else if (totalPassengers >= 5 || totalPassengers === 0) { // Dla 0 i od 5 w górę, użyj "pasażerów"
                 passengersText = `${totalPassengers} pasażerów`;
            }
            topBarPassengers.textContent = `Pasażerowie: Dorośli ${currentAdults}, Nastolatkowie ${currentTeenagers}, Dzieci ${currentChildren}, Niemowlęta z miejscem ${currentInfantsSeat}, Niemowlęta ${currentInfantsLap}`;

            // Pokaż lub ukryj sekcję lotów powrotnych
            if (currentReturnDate) {
                returnFlightsSection.classList.remove('hidden');
            } else {
                returnFlightsSection.classList.add('hidden');
            }
        }


        // Inicjalizacja strony
        function initializePage() {
            const params = getQueryParams();

            // Ustaw zmienne globalne na podstawie URL
            currentDepartureCity = extractCityName(params.from || '');
            currentArrivalCity = extractCityName(params.to || '');
            currentDepartureDate = params.date_from || ''; // DD.MM.RRRR
            currentReturnDate = params.date_to || null; // DD.MM.RRRR
            currentSelectedClass = params.class || "Economy";
            currentAdults = parseInt(params.adults || 1);
            currentTeenagers = parseInt(params.teenagers || 0);
            currentChildren = parseInt(params.children || 0);
            currentInfantsSeat = parseInt(params.infantsSeat || 0);
            currentInfantsLap = parseInt(params.infantsLap || 0);


            // Ustaw nagłówki i podsumowanie
            updateSummaryDisplay();
            departureFlightHeading.textContent = `Loty z ${currentDepartureCity} (${currentDepartureCity.substring(0, 3).toUpperCase()}) do ${currentArrivalCity} (${currentArrivalCity.substring(0, 3).toUpperCase()})`;
            if (currentReturnDate) {
                returnFlightHeading.textContent = `Loty z ${currentArrivalCity} (${currentArrivalCity.substring(0, 3).toUpperCase()}) do ${currentDepartureCity} (${currentDepartureCity.substring(0, 3).toUpperCase()})`;
            }


            // Renderuj slidery dat i loty
            // Konwertuj DD.MM.RRRR na YYYY-MM-DD dla Date object
            let depDateObj = new Date(currentDepartureDate.split('.').reverse().join('-'));
            renderDateSlider(depDateObj, departureDateList, 'departure', (selectedDateStr) => {
                currentDepartureDate = formatDate(selectedDateStr); // Zapisz sformatowaną datę
                renderFlights(selectedDateStr, 'departure', departureFlightListings, noDepartureFlightsMessage, departureClassRestrictionMessage);
            });
            // Ręcznie wywołaj renderFlights dla domyślnej daty wylotu (tej, która zostanie zaznaczona w sliderze)
            const initialDepDateStr = depDateObj.toISOString().slice(0, 10); // Format YYYY-MM-DD
            renderFlights(initialDepDateStr, 'departure', departureFlightListings, noDepartureFlightsMessage, departureClassRestrictionMessage);


            if (currentReturnDate) {
                let retDateObj = new Date(currentReturnDate.split('.').reverse().join('-'));
                renderDateSlider(retDateObj, returnDateList, 'return', (selectedDateStr) => {
                    currentReturnDate = formatDate(selectedDateStr);
                    renderFlights(selectedDateStr, 'return', returnFlightListings, noReturnFlightsMessage, returnClassRestrictionMessage);
                });
                const initialRetDateStr = retDateObj.toISOString().slice(0, 10); // Format YYYY-MM-DD
                renderFlights(initialRetDateStr, 'return', returnFlightListings, noReturnFlightsMessage, returnClassRestrictionMessage);
            }

            // Inicjalizacja modali edycji wyszukiwania
            setupEditSearchModals();
        }

        // Uruchom inicjalizację strony po załadowaniu DOM
        document.addEventListener('DOMContentLoaded', initializePage);

    </script>
</body>
</html>
