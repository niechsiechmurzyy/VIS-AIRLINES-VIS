<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIS Airlines - Wyniki Wyszukiwania Lotów</title>
    <link rel="icon" href="assets/images/logo.png" type="image/png">
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* Styles for Ryanair-like flight results page */
        main {
            padding: 0; /* Usuwamy padding z main, sekcje będą miały swój */
            max-width: none; /* Używamy pełnej szerokości */
            box-shadow: none; /* Usuwamy cień */
            background-color: #f4f4f4; /* Tło strony */
        }

        .navbar {
            background-color: #0056b3;
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .navbar .nav-left, .navbar .nav-right {
            display: flex;
            align-items: center;
        }
        .navbar .nav-link {
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }
        .navbar .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        .navbar .nav-item {
            position: relative;
            margin-left: 20px;
        }
        .navbar .nav-icon {
            width: 24px;
            height: 24px;
            cursor: pointer;
            vertical-align: middle;
        }
        .navbar .dropdown-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 120px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            right: 0;
            border-radius: 4px;
            overflow: hidden;
        }
        .navbar .dropdown-content a {
            color: black;
            padding: 10px 16px;
            text-decoration: none;
            display: block;
            text-align: left;
        }
        .navbar .dropdown-content a:hover {
            background-color: #ddd;
        }
        .navbar .dropdown-content.show {
            display: block;
        }


        .top-bar {
            background-color: #e0f2f7; /* Jasnoniebieskie tło górnej belki */
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1em;
            color: #333;
            border-bottom: 1px solid #cceeff;
        }

        .top-bar .route-info {
            font-weight: bold;
            color: #0056b3;
        }

        .top-bar .edit-search-btn {
            background-color: #007bff;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
        }
        .top-bar .edit-search-btn:hover {
            background-color: #0056b3;
        }

        .tab-navigation {
            background-color: #ffffff;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .tab-navigation a {
            padding: 15px 25px;
            text-decoration: none;
            color: #555;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .tab-navigation a:hover {
            background-color: #f0f0f0;
        }

        .tab-navigation a.active {
            color: #007bff;
            border-bottom: 3px solid #007bff;
            background-color: #e6f7ff;
        }

        .tab-navigation img {
            width: 20px;
            height: 20px;
            vertical-align: middle;
        }

        .flight-section {
            max-width: 960px;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        h2 {
            text-align: center;
            color: #007bff;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .date-slider {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding: 10px 0;
            background-color: #f8f8f8;
            border-radius: 8px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }

        .date-slider-arrow {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.2em;
            transition: background-color 0.3s ease;
            margin: 0 10px;
        }
        .date-slider-arrow:hover {
            background-color: #0056b3;
        }

        .date-list {
            display: flex;
            overflow-x: auto; /* Pozwala na przewijanie dat, jeśli jest ich wiele */
            scroll-behavior: smooth;
            flex-grow: 1;
            justify-content: flex-start; /* Domyślnie wyrównaj do lewej */
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .date-list::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }

        .date-item {
            flex: 0 0 auto; /* Nie rozciągaj, nie kurcz, zachowaj rozmiar */
            padding: 10px 15px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            min-width: 100px; /* Minimalna szerokość dla każdej daty */
            margin: 0 5px;
        }

        .date-item.selected {
            background-color: #e6f7ff; /* Jasnoniebieskie tło dla wybranej daty */
            border: 2px solid #007bff;
            color: #007bff;
            font-weight: bold;
            transform: translateY(-3px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .date-item .day-name {
            font-size: 0.9em;
            color: #777;
        }
        .date-item .day-number {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
            margin-top: 5px;
        }
        .date-item .price {
            font-size: 1.1em;
            color: #28a745;
            font-weight: bold;
            margin-top: 5px;
        }
        .date-item.selected .day-name, .date-item.selected .day-number, .date-item.selected .price {
            color: #007bff; /* Tekst również niebieski dla wybranej daty */
        }

        .flight-card {
            background-color: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .flight-segment {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-bottom: 10px;
        }

        .flight-time-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-grow: 1;
        }

        .flight-times {
            font-size: 1.8em;
            font-weight: bold;
            color: #007bff;
            display: flex;
            gap: 10px;
        }
        .flight-times span {
            white-space: nowrap;
        }

        .flight-route-duration {
            flex-grow: 1;
        }
        .flight-route {
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
        }
        .flight-duration {
            font-size: 0.9em;
            color: #777;
            margin-top: 3px;
        }

        .flight-operator {
            font-size: 0.8em;
            color: #888;
            background-color: #f0f0f0;
            padding: 5px 10px;
            border-radius: 5px;
            white-space: nowrap;
        }

        .flight-details-bottom {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .flight-price {
            font-size: 2em;
            font-weight: bold;
            color: #28a745;
        }

        .select-flight-btn {
            background-color: #007bff;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.3s ease;
        }
        .select-flight-btn:hover {
            background-color: #0056b3;
        }

        /* Style for no flights message */
        .no-flights-message, .class-restriction-message {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: #d9534f;
            background-color: #fdd;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            margin-top: 30px;
        }

        .hidden {
            display: none;
        }

        /* Sekcja edycji wyszukiwania - na wzór Ryanair */
        .edit-search-section {
            background-color: #f0f8ff; /* Jasnoniebieskie tło */
            border: 1px solid #cceeff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .edit-search-section h3 {
            margin-top: 0;
            color: #0056b3;
            font-size: 1.5em;
            text-align: center;
            margin-bottom: 20px;
        }

        .edit-search-section .form-group {
            margin-bottom: 15px;
        }

        .edit-search-section .form-group label {
            font-weight: bold;
            color: #555;
            margin-bottom: 5px;
            display: block;
        }

        .edit-search-section .form-group input[type="text"] {
            width: calc(100% - 22px); /* Pełna szerokość z paddingiem i borderem */
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1em;
            cursor: pointer;
        }

        .edit-search-section .buttons-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .edit-search-section .buttons-container button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }

        .edit-search-section .buttons-container button:hover {
            background-color: #0056b3;
        }

        /* Responsywność */
        @media (max-width: 768px) {
            .top-bar {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .tab-navigation {
                overflow-x: auto;
                justify-content: flex-start;
            }
            .tab-navigation a {
                flex-shrink: 0; /* Zapobiega kurczeniu się zakładek */
            }
            .date-list {
                justify-content: flex-start;
            }
            .flight-segment {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .flight-time-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            .flight-details-bottom {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .select-flight-btn {
                width: 100%;
            }
        }
        @media (max-width: 480px) {
            .flight-section {
                padding: 10px;
            }
            .date-slider-arrow {
                padding: 8px 12px;
                font-size: 1em;
            }
            .date-item {
                min-width: 80px;
                padding: 8px 10px;
            }
            .flight-times {
                font-size: 1.5em;
            }
            .flight-price {
                font-size: 1.5em;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-left">
            <a href="index.html" class="nav-link">Zarezerwuj lot</a>
            <a href="#" class="nav-link">Odpraw się</a>
            <a href="#" class="nav-link">Zarządzaj rezerwacją</a>
        </div>
        <div class="nav-right">
            <div class="nav-item dropdown">
                <img src="assets/images/language-icon.png" alt="Język" class="nav-icon" id="language-icon">
                <div class="dropdown-content" id="language-dropdown">
                    <a href="#">Polski</a>
                    <a href="#">English</a>
                    <a href="#">Deutsch</a>
                </div>
            </div>
            <div class="nav-item dropdown">
                <img src="assets/images/currency-icon.png" alt="Waluta" class="nav-icon" id="currency-icon">
                <div class="dropdown-content" id="currency-dropdown">
                    <a href="#">PLN</a>
                    <a href="#">USD</a>
                    <a href="#">EUR</a>
                </div>
            </div>
            <div class="nav-item dropdown">
                <img src="assets/images/account-icon.png" alt="Konto" class="nav-icon" id="account-icon">
                <div class="dropdown-content" id="account-dropdown">
                    <a href="#" id="login-link">Zaloguj się</a>
                    <a href="register.html" id="register-link">Zarejestruj się</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="top-bar">
        <div class="route-info" id="top-bar-route"></div>
        <div class="passengers-info" id="top-bar-passengers"></div>
        <button class="edit-search-btn" id="edit-search-toggle">Edytuj wyszukiwanie</button>
    </div>

    <div class="tab-navigation">
        <a href="#" class="active"><img src="assets/images/plane-icon.png" alt="Loty"> Loty</a>
        <a href="#"><img src="assets/images/seat-icon.png" alt="Miejsca"> Miejsca</a>
        <a href="#"><img src="assets/images/baggage-icon.png" alt="Bagaż"> Bagaż</a>
        <a href="#"><img src="assets/images/extras-icon.png" alt="Dodatki"> Dodatki</a>
        <a href="#"><img src="assets/images/payment-icon.png" alt="Przejdź i zapłać"> Przejdź i zapłać</a>
    </div>

    <main>
        <section class="flight-section" id="departure-flights-section">
            <h2 id="departure-flight-heading">Loty z Gdańsk (GDN) do Warszawa (WAW)</h2>

            <div class="edit-search-section hidden" id="edit-search-details">
                <h3>Edytuj wyszukiwanie</h3>
                <div class="form-group">
                    <label for="editDepartureCity">Miasto wylotu:</label>
                    <input type="text" id="editDepartureCity" placeholder="Wybierz miasto" required readonly>
                </div>
                <div class="form-group">
                    <label for="editArrivalCity">Miasto przylotu:</label>
                    <input type="text" id="editArrivalCity" placeholder="Wybierz miasto" required readonly>
                </div>
                <div class="form-group">
                    <label for="editDepartureDate">Data wylotu:</label>
                    <input type="text" id="editDepartureDate" placeholder="dd. mm. rrrr" required readonly>
                </div>
                <div class="form-group">
                    <label for="editReturnDate">Data powrotu (opcjonalnie):</label>
                    <input type="text" id="editReturnDate" placeholder="dd. mm. rrrr" readonly>
                </div>
                <div class="form-group">
                    <label for="editClassPassengers">Klasa i pasażerowie:</label>
                    <input type="text" id="editClassPassengers" placeholder="Wybierz klasę i liczbę pasażerów" required readonly>
                </div>
                <div class="buttons-container">
                    <button id="update-search-btn">Zaktualizuj wyszukiwanie</button>
                    <button id="cancel-edit-btn">Anuluj</button>
                </div>
            </div>

            <div class="date-slider">
                <button class="date-slider-arrow" id="prev-departure-day">&lt;</button>
                <div class="date-list" id="departure-date-list">
                    </div>
                <button class="date-slider-arrow" id="next-departure-day">&gt;</button>
            </div>

            <div id="departure-flight-listings">
                </div>

            <p class="no-flights-message hidden" id="no-departure-flights-message">Brak dostępnych lotów w wybranej dacie.</p>
            <p class="class-restriction-message hidden" id="departure-class-restriction-message">Wybrana klasa podróży nie jest obsługiwana dla tej trasy.</p>
        </section>

        <section class="flight-section hidden" id="return-flights-section">
            <h2 id="return-flight-heading">Loty z Warszawa (WAW) do Gdańsk (GDN)</h2>
            <div class="date-slider">
                <button class="date-slider-arrow" id="prev-return-day">&lt;</button>
                <div class="date-list" id="return-date-list">
                    </div>
                <button class="date-slider-arrow" id="next-return-day">&gt;</button>
            </div>

            <div id="return-flight-listings">
                </div>
            <p class="no-flights-message hidden" id="no-return-flights-message">Brak dostępnych lotów powrotnych w wybranej dacie.</p>
            <p class="class-restriction-message hidden" id="return-class-restriction-message">Wybrana klasa podróży nie jest obsługiwana dla tej trasy.</p>
        </section>
    </main>

    <footer>
        <p>&copy; 2025 VIS Airlines. Wszystkie prawa zastrzeżone.</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const initialDepartureCity = params.get('departureCity');
            const initialArrivalCity = params.get('arrivalCity');
            let initialDepartureDate = params.get('departureDate');
            let initialReturnDate = params.get('returnDate'); // Może być null
            let initialSelectedClass = params.get('selectedClass');
            let initialAdults = parseInt(params.get('adults') || 1);
            let initialTeenagers = parseInt(params.get('teenagers') || 0);
            let initialChildren = parseInt(params.get('children') || 0);
            let initialInfantsSeat = parseInt(params.get('infants-seat') || 0);
            let initialInfantsLap = parseInt(params.get('infants-lap') || 0);

            // Pobieranie elementów DOM
            const topBarRoute = document.getElementById('top-bar-route');
            const topBarPassengers = document.getElementById('top-bar-passengers');
            const departureFlightHeading = document.getElementById('departure-flight-heading');
            const returnFlightHeading = document.getElementById('return-flight-heading');
            const departureDateList = document.getElementById('departure-date-list');
            const returnDateList = document.getElementById('return-date-list');
            const departureFlightListings = document.getElementById('departure-flight-listings');
            const returnFlightListings = document.getElementById('return-flight-listings');
            const noDepartureFlightsMessage = document.getElementById('no-departure-flights-message');
            const noReturnFlightsMessage = document.getElementById('no-return-flights-message');
            const departureClassRestrictionMessage = document.getElementById('departure-class-restriction-message');
            const returnClassRestrictionMessage = document.getElementById('return-class-restriction-message');
            const departureFlightsSection = document.getElementById('departure-flights-section');
            const returnFlightsSection = document.getElementById('return-flights-section');
            const editSearchToggle = document.getElementById('edit-search-toggle');
            const editSearchDetails = document.getElementById('edit-search-details');
            const updateSearchBtn = document.getElementById('update-search-btn');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');

            // Nowe elementy inputów w sekcji edycji wyszukiwania
            const editDepartureCity = document.getElementById('editDepartureCity');
            const editArrivalCity = document.getElementById('editArrivalCity');
            const editDepartureDate = document.getElementById('editDepartureDate');
            const editReturnDate = document.getElementById('editReturnDate');
            const editClassPassengers = document.getElementById('editClassPassengers');

            // Ustawienia dla modala wyboru miasta
            const citySelectionModal = document.getElementById('citySelectionModal'); // Modal z index.html
            const cityListItems = citySelectionModal.querySelectorAll('.city-list li');
            let currentEditCityInput = null; // Przechowuje aktywne pole miasta w edycji

            // Ustawienia dla modala kalendarza
            const calendarModal = document.getElementById('calendarModal'); // Modal z index.html
            const calendarContainer = document.getElementById('calendar-container');
            let currentEditCalendarInput = null; // Przechowuje aktywne pole daty w edycji
            let currentEditSelectedDepartureDate = null;
            let currentEditSelectedReturnDate = null;

            // Ustawienia dla modala klasy/pasażerów
            const travelDetailsModal = document.getElementById('travelDetailsModal'); // Modal z index.html
            const classButtons = travelDetailsModal.querySelectorAll('.class-button');
            const passengerCounts = {
                adults: initialAdults, teenagers: initialTeenagers, children: initialChildren, 'infants-seat': initialInfantsSeat, 'infants-lap': initialInfantsLap
            };
            const quantityControls = travelDetailsModal.querySelectorAll('.quantity-control button');
            const confirmPassengersBtn = travelDetailsModal.querySelector('.confirm-passengers-btn');
            let currentEditSelectedClass = initialSelectedClass;

            // Zmienne do przechowywania aktualnych kryteriów wyszukiwania
            let currentDepartureCity = initialDepartureCity;
            let currentArrivalCity = initialArrivalCity;
            let currentDepartureDate = initialDepartureDate;
            let currentReturnDate = initialReturnDate;
            let currentSelectedClass = initialSelectedClass;
            let currentAdults = initialAdults;
            let currentTeenagers = initialTeenagers;
            let currentChildren = initialChildren;
            let currentInfantsSeat = initialInfantsSeat;
            let currentInfantsLap = initialInfantsLap;


            // --- Funkcje pomocnicze ---

            function closeAllModals() {
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.style.display = 'none';
                });
            }

            // Funkcja do formatowania daty na DD. MM. RRRR
            function formatDate(dateString) {
                const date = new Date(dateString);
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0'); // Miesiące są 0-11
                const year = date.getFullYear();
                return `${day}.${month}.${year}`;
            }

            // Funkcja do formatowania daty na Dzień, DD miesiąca
            function formatDayAndMonth(date) {
                const dayNames = ["Nie", "Pon", "Wt", "Śr", "Czw", "Pt", "Sob"];
                const monthNamesShort = ["Sty", "Lut", "Mar", "Kwi", "Maj", "Cze", "Lip", "Sie", "Wrz", "Paź", "Lis", "Gru"];
                const dayOfWeek = dayNames[date.getDay()];
                const dayOfMonth = date.getDate();
                const monthName = monthNamesShort[date.getMonth()];
                return {
                    dayOfWeek: dayOfWeek,
                    dayOfMonth: dayOfMonth,
                    monthName: monthName
                };
            }

            // --- Dane lotów (Symulacja dla Gdańsk -> Warszawa) ---
            const simulatedFlights = [
                { // Lot Gdańsk -> Warszawa
                    from: "Gdańsk",
                    to: "Warszawa",
                    flightNumber: "VIS101",
                    departureTime: "05:00",
                    arrivalTime: "05:55",
                    duration: "0h 55min",
                    basePrice: 199, // Bazowa cena
                    restrictedClasses: [], // Brak ograniczeń dla tego lotu, jeśli chcemy go zawsze pokazywać
                    operator: "VIS Airlines",
                    // Symulowane ceny dla różnych dat (możesz edytować)
                    dailyPrices: {
                        "2025-07-13": 199, "2025-07-14": 210, "2025-07-15": 205, "2025-07-16": 220, "2025-07-17": 195, "2025-07-18": 230, "2025-07-19": 200,
                        "2025-07-20": 199, "2025-07-21": 210, "2025-07-22": 205, "2025-07-23": 220, "2025-07-24": 195, "2025-07-25": 230, "2025-07-26": 200,
                        "2025-07-27": 199, "2025-07-28": 210, "2025-07-29": 205, "2025-07-30": 220, "2025-07-31": 195, "2025-08-01": 230, "2025-08-02": 200
                        // Możesz dodać więcej dat i cen
                    }
                }
            ];

            // --- Generowanie dynamicznych elementów ---

            // Funkcja renderująca loty dla danej daty i kierunku
            function renderFlights(dateStr, direction, containerElement, noFlightsMsgElement, classRestrictionMsgElement) {
                containerElement.innerHTML = ''; // Wyczyść poprzednie loty
                noFlightsMsgElement.classList.add('hidden');
                classRestrictionMsgElement.classList.add('hidden');

                const targetFrom = direction === 'departure' ? currentDepartureCity : currentArrivalCity;
                const targetTo = direction === 'departure' ? currentArrivalCity : currentDepartureCity;

                const foundFlights = simulatedFlights.filter(flight =>
                    flight.from === targetFrom &&
                    flight.to === targetTo
                );

                if (foundFlights.length === 0) {
                    noFlightsMsgElement.classList.remove('hidden');
                    return;
                }

                let classRestricted = false;
                let flightsDisplayed = false;

                foundFlights.forEach(flight => {
                    if (flight.restrictedClasses.includes(currentSelectedClass)) {
                        classRestricted = true;
                        return; // Nie pokazuj lotu, jeśli klasa jest ograniczona
                    }

                    const price = flight.dailyPrices[dateStr] || flight.basePrice; // Pobierz cenę dla konkretnej daty lub bazową

                    const flightCard = document.createElement('div');
                    flightCard.classList.add('flight-card');
                    flightCard.innerHTML = `
                        <div class="flight-segment">
                            <div class="flight-time-info">
                                <div class="flight-times">
                                    <span>${flight.departureTime}</span>
                                    <span>&ndash;</span>
                                    <span>${flight.arrivalTime}</span>
                                </div>
                                <div class="flight-route-duration">
                                    <div class="flight-route">${flight.from} (${flight.from.substring(0, 3).toUpperCase()}) &rarr; ${flight.to} (${flight.to.substring(0, 3).toUpperCase()})</div>
                                    <div class="flight-duration">${flight.duration}</div>
                                </div>
                            </div>
                            <div class="flight-operator">${flight.operator}</div>
                        </div>
                        <div class="flight-details-bottom">
                            <div class="flight-price">${price} PLN</div>
                            <button class="select-flight-btn">Wybierz lot</button>
                        </div>
                    `;
                    containerElement.appendChild(flightCard);
                    flightsDisplayed = true;

                    flightCard.querySelector('.select-flight-btn').addEventListener('click', () => {
                        alert(`Wybrano lot ${flight.flightNumber} z ${flight.from} do ${flight.to} dnia ${formatDate(dateStr)} o ${flight.departureTime} za ${price} PLN! Przejście do następnego etapu.`);
                        // Tutaj można by przekierować na stronę podsumowania/płatności
                    });
                });

                if (!flightsDisplayed && classRestricted) {
                    classRestrictionMsgElement.classList.remove('hidden');
                } else if (!flightsDisplayed) {
                    noFlightsMsgElement.classList.remove('hidden');
                }
            }

            // Funkcja generująca i obsługująca daty w sliderze
            function renderDateSlider(targetDate, dateListElement, direction, selectedCallback) {
                dateListElement.innerHTML = '';
                const today = new Date();
                today.setHours(0,0,0,0);

                for (let i = -3; i <= 3; i++) { // 7 dni: 3 dni wstecz, dzisiaj, 3 dni w przód
                    const date = new Date(targetDate);
                    date.setDate(date.getDate() + i);
                    date.setHours(0,0,0,0);

                    const formatted = formatDayAndMonth(date);
                    const dateStr = date.toISOString().split('T')[0]; // Format YYYY-MM-DD

                    const dateItem = document.createElement('div');
                    dateItem.classList.add('date-item');
                    dateItem.innerHTML = `
                        <div class="day-name">${formatted.dayOfWeek}</div>
                        <div class="day-number">${formatted.dayOfMonth} ${formatted.monthName}</div>
                        <div class="price">${simulatedFlights[0].dailyPrices[dateStr] || simulatedFlights[0].basePrice} PLN</div>
                    `;
                    dateItem.dataset.date = dateStr;

                    // Wyłącz daty z przeszłości
                    if (date < today) {
                         dateItem.classList.add('disabled');
                         dateItem.style.pointerEvents = 'none';
                         dateItem.querySelector('.price').textContent = '-'; // Brak ceny dla przeszłości
                         dateItem.style.opacity = '0.6';
                    }


                    dateItem.addEventListener('click', () => {
                        // Usuń zaznaczenie z poprzednio wybranej daty
                        dateListElement.querySelectorAll('.date-item').forEach(item => item.classList.remove('selected'));
                        // Zaznacz klikniętą datę
                        dateItem.classList.add('selected');
                        selectedCallback(dateStr); // Wywołaj callback z wybraną datą
                    });
                    dateListElement.appendChild(dateItem);
                }
                // Domyślnie zaznacz środkową datę (lub datę z URL, jeśli jest dostępna i mieści się w sliderze)
                const defaultSelectedDateElement = dateListElement.querySelector(`[data-date="${targetDate.toISOString().split('T')[0]}"]`);
                if (defaultSelectedDateElement) {
                    defaultSelectedDateElement.classList.add('selected');
                } else {
                    // Jeśli data z URL nie jest w zakresie wyświetlanych 7 dni, wybierz środkową (lub najbliższą poprawną)
                    const middleIndex = 3; // Index dla dzisiaj
                    if (dateListElement.children[middleIndex] && !dateListElement.children[middleIndex].classList.contains('disabled')) {
                        dateListElement.children[middleIndex].classList.add('selected');
                        selectedCallback(dateListElement.children[middleIndex].dataset.date);
                    } else {
                        // Fallback: znajdź pierwszą niedostępną datę
                         for(let i=0; i<dateListElement.children.length; i++){
                            if(!dateListElement.children[i].classList.contains('disabled')){
                                dateListElement.children[i].classList.add('selected');
                                selectedCallback(dateListElement.children[i].dataset.date);
                                break;
                            }
                         }
                    }
                }
            }


            // --- Inicjalizacja strony ---

            function initializePage() {
                // Ustaw nagłówki i podsumowanie
                topBarRoute.textContent = `${currentDepartureCity} (${currentDepartureCity.substring(0, 3).toUpperCase()}) → ${currentArrivalCity} (${currentArrivalCity.substring(0, 3).toUpperCase()})`;
                const totalPassengers = currentAdults + currentTeenagers + currentChildren + currentInfantsSeat + currentInfantsLap;
                topBarPassengers.textContent = `${totalPassengers} pasażerów`;
                departureFlightHeading.textContent = `Loty z ${currentDepartureCity} (${currentDepartureCity.substring(0, 3).toUpperCase()}) do ${currentArrivalCity} (${currentArrivalCity.substring(0, 3).toUpperCase()})`;

                if (initialReturnDate) {
                    returnFlightsSection.classList.remove('hidden');
                    returnFlightHeading.textContent = `Loty z ${currentArrivalCity} (${currentArrivalCity.substring(0, 3).toUpperCase()}) do ${currentDepartureCity} (${currentDepartureCity.substring(0, 3).toUpperCase()})`;
                } else {
                    returnFlightsSection.classList.add('hidden');
                }

                // Renderuj slidery dat i loty
                let depDate = new Date(currentDepartureDate.split('.').reverse().join('-')); // Konwertuj DD.MM.RRRR na RRRR-MM-DD
                renderDateSlider(depDate, departureDateList, 'departure', (selectedDateStr) => {
                    currentDepartureDate = formatDate(selectedDateStr); // Zapisz sformatowaną datę
                    renderFlights(selectedDateStr, 'departure', departureFlightListings, noDepartureFlightsMessage, departureClassRestrictionMessage);
                });
                // Ręcznie wywołaj renderFlights dla domyślnej daty wylotu
                renderFlights(depDate.toISOString().split('T')[0], 'departure', departureFlightListings, noDepartureFlightsMessage, departureClassRestrictionMessage);


                if (initialReturnDate) {
                    let retDate = new Date(currentReturnDate.split('.').reverse().join('-'));
                    renderDateSlider(retDate, returnDateList, 'return', (selectedDateStr) => {
                        currentReturnDate = formatDate(selectedDateStr);
                        renderFlights(selectedDateStr, 'return', returnFlightListings, noReturnFlightsMessage, returnClassRestrictionMessage);
                    });
                     // Ręcznie wywołaj renderFlights dla domyślnej daty powrotu
                    renderFlights(retDate.toISOString().split('T')[0], 'return', returnFlightListings, noReturnFlightsMessage, returnClassRestrictionMessage);
                }

                // Inicjalizacja modali (te same funkcje co na index.html)
                setupEditSearchModals();

            }

            initializePage();

            // --- Obsługa edycji wyszukiwania ---

            editSearchToggle.addEventListener('click', () => {
                editSearchDetails.classList.toggle('hidden');
                // Ustaw bieżące wartości w polach edycji
                editDepartureCity.value = currentDepartureCity;
                editArrivalCity.value = currentArrivalCity;
                editDepartureDate.value = currentDepartureDate;
                editReturnDate.value = currentReturnDate || ''; // Puste jeśli brak
                updateEditClassPassengersInput();

                // Przygotuj daty dla kalendarza w modalu edycji
                currentEditSelectedDepartureDate = currentDepartureDate ? new Date(currentDepartureDate.split('.').reverse().join('-')) : null;
                currentEditSelectedReturnDate = currentReturnDate ? new Date(currentReturnDate.split('.').reverse().join('-')) : null;
                // Upewnij się, że liczniki pasażerów w modalu są zgodne z bieżącymi
                document.getElementById('adults-count').textContent = passengerCounts.adults;
                document.getElementById('teenagers-count').textContent = passengerCounts.teenagers;
                document.getElementById('children-count').textContent = passengerCounts.children;
                document.getElementById('infants-seat-count').textContent = passengerCounts['infants-seat'];
                document.getElementById('infants-lap-count').textContent = passengerCounts['infants-lap'];

                // Ustaw wybrana klasę
                classButtons.forEach(btn => {
                    if (btn.dataset.class === currentSelectedClass) {
                        btn.classList.add('selected');
                    } else {
                        btn.classList.remove('selected');
                    }
                });
                currentEditSelectedClass = currentSelectedClass; // Zaktualizuj zmienną dla modala
            });

            cancelEditBtn.addEventListener('click', () => {
                editSearchDetails.classList.add('hidden');
            });

            updateSearchBtn.addEventListener('click', () => {
                // Zaktualizuj globalne zmienne kryteriów
                currentDepartureCity = editDepartureCity.value;
                currentArrivalCity = editArrivalCity.value;
                currentDepartureDate = editDepartureDate.value;
                currentReturnDate = editReturnDate.value;
                currentSelectedClass = currentEditSelectedClass; // Zaktualizuj z wartości z modala
                currentAdults = passengerCounts.adults;
                currentTeenagers = passengerCounts.teenagers;
                currentChildren = passengerCounts.children;
                currentInfantsSeat = passengerCounts['infants-seat'];
                currentInfantsLap = passengerCounts['infants-lap'];

                // Ponownie zainicjuj całą stronę, aby odzwierciedlić nowe kryteria
                initializePage();
                editSearchDetails.classList.add('hidden'); // Ukryj sekcję edycji po aktualizacji
            });


            function setupEditSearchModals() {
                // Miasta
                editDepartureCity.addEventListener('click', () => {
                    closeAllModals();
                    currentEditCityInput = editDepartureCity;
                    citySelectionModal.style.display = 'block';
                });
                editArrivalCity.addEventListener('click', () => {
                    closeAllModals();
                    currentEditCityInput = editArrivalCity;
                    citySelectionModal.style.display = 'block';
                });
                cityListItems.forEach(item => {
                    item.addEventListener('click', () => {
                        if (currentEditCityInput) {
                            currentEditCityInput.value = item.textContent;
                            citySelectionModal.style.display = 'none';
                        }
                    });
                });

                // Daty
                editDepartureDate.addEventListener('click', () => {
                    closeAllModals();
                    currentEditCalendarInput = editDepartureDate;
                    renderEditCalendar();
                    calendarModal.style.display = 'block';
                });
                editReturnDate.addEventListener('click', () => {
                    closeAllModals();
                    currentEditCalendarInput = editReturnDate;
                    renderEditCalendar();
                    calendarModal.style.display = 'block';
                });

                // Klasa/Pasażerowie
                editClassPassengers.addEventListener('click', () => {
                    closeAllModals();
                    travelDetailsModal.style.display = 'block';
                    // Upewnij się, że liczniki i wybrana klasa są poprawne w modalu
                    document.getElementById('adults-count').textContent = passengerCounts.adults;
                    document.getElementById('teenagers-count').textContent = passengerCounts.teenagers;
                    document.getElementById('children-count').textContent = passengerCounts.children;
                    document.getElementById('infants-seat-count').textContent = passengerCounts['infants-seat'];
                    document.getElementById('infants-lap-count').textContent = passengerCounts['infants-lap'];

                    classButtons.forEach(btn => {
                        if (btn.dataset.class === currentEditSelectedClass) {
                            btn.classList.add('selected');
                        } else {
                            btn.classList.remove('selected');
                        }
                    });
                });

                confirmPassengersBtn.addEventListener('click', () => {
                    if (passengerCounts.adults < 1) {
                        alert("Musisz wybrać co najmniej jednego dorosłego pasażera.");
                        return;
                    }
                    travelDetailsModal.style.display = 'none';
                    updateEditClassPassengersInput();
                });

                 // Funkcja do aktualizacji inputa klasy/pasażerów w sekcji edycji
                function updateEditClassPassengersInput() {
                    let totalPassengers = 0;
                    for (const type in passengerCounts) {
                        totalPassengers += passengerCounts[type];
                    }
                    let summaryText = '';
                    if (currentEditSelectedClass) {
                        summaryText += `${currentEditSelectedClass}`;
                    }
                    if (totalPassengers > 0) {
                        if (summaryText) summaryText += ", ";
                        summaryText += `${totalPassengers} pasażerów`;
                    } else {
                         if (summaryText) summaryText += ", ";
                         summaryText += `0 pasażerów`;
                    }
                    editClassPassengers.value = summaryText || "Wybierz klasę i liczbę pasażerów";
                }


                // Logika renderowania kalendarza (powielona z index.html, ale dostosowana do edycji)
                let tempCalendarDate = new Date();
                tempCalendarDate.setDate(1);

                function renderEditCalendar() {
                    calendarContainer.innerHTML = '';

                    const monthNames = ["Styczeń", "Luty", "Marzec", "Kwiecień", "Maj", "Czerwiec", "Lipiec", "Sierpień", "Wrzesień", "Październik", "Listopad", "Grudzień"];
                    const dayNames = ["Nie", "Pon", "Wt", "Śr", "Czw", "Pt", "Sob"];

                    const year = tempCalendarDate.getFullYear();
                    const month = tempCalendarDate.getMonth();
                    const firstDayOfMonth = new Date(year, month, 1).getDay();
                    const daysInMonth = new Date(year, month + 1, 0).getDate();

                    const navDiv = document.createElement('div');
                    navDiv.classList.add('calendar-nav');
                    const prevMonthBtn = document.createElement('button');
                    prevMonthBtn.textContent = '<';
                    prevMonthBtn.addEventListener('click', () => {
                        tempCalendarDate.setMonth(tempCalendarDate.getMonth() - 1);
                        renderEditCalendar();
                    });
                    const nextMonthBtn = document.createElement('button');
                    nextMonthBtn.textContent = '>';
                    nextMonthBtn.addEventListener('click', () => {
                        tempCalendarDate.setMonth(tempCalendarDate.getMonth() + 1);
                        renderEditCalendar();
                    });
                    const monthYearSpan = document.createElement('span');
                    monthYearSpan.classList.add('current-month-year');
                    monthYearSpan.textContent = `${monthNames[month]} ${year}`;
                    navDiv.appendChild(prevMonthBtn);
                    navDiv.appendChild(monthYearSpan);
                    navDiv.appendChild(nextMonthBtn);
                    calendarContainer.appendChild(navDiv);

                    const table = document.createElement('table');
                    const thead = document.createElement('thead');
                    const tbody = document.createElement('tbody');

                    const headerRow = document.createElement('tr');
                    dayNames.forEach(day => {
                        const th = document.createElement('th');
                        th.textContent = day;
                        headerRow.appendChild(th);
                    });
                    thead.appendChild(headerRow);
                    table.appendChild(thead);

                    let date = 1;
                    for (let i = 0; i < 6; i++) {
                        const row = document.createElement('tr');
                        for (let j = 0; j < 7; j++) {
                            const cell = document.createElement('td');
                            if (i === 0 && j < firstDayOfMonth) {
                                cell.textContent = '';
                            } else if (date > daysInMonth) {
                                cell.textContent = '';
                            } else {
                                const cellDate = new Date(year, month, date);
                                cellDate.setHours(0,0,0,0);

                                cell.textContent = date;
                                const today = new Date();
                                today.setHours(0,0,0,0);
                                const maxDate = new Date();
                                maxDate.setFullYear(maxDate.getFullYear() + 1);
                                maxDate.setHours(23,59,59,999);

                                if (cellDate < today || cellDate > maxDate) {
                                    cell.classList.add('disabled');
                                    cell.style.pointerEvents = 'none';
                                } else {
                                    cell.dataset.date = cellDate.toISOString().split('T')[0];
                                    cell.addEventListener('click', (event) => {
                                        const clickedDateString = event.target.dataset.date;
                                        const clickedDate = new Date(clickedDateString);
                                        clickedDate.setHours(0,0,0,0);

                                        if (currentEditCalendarInput === editDepartureDate) {
                                            currentEditSelectedDepartureDate = clickedDate;
                                            editDepartureDate.value = clickedDate.toLocaleDateString('pl-PL');
                                            currentEditSelectedReturnDate = null;
                                            editReturnDate.value = '';
                                        } else if (currentEditCalendarInput === editReturnDate) {
                                            if (currentEditSelectedDepartureDate && clickedDate < currentEditSelectedDepartureDate) {
                                                alert('Data powrotu nie może być wcześniejsza niż data wylotu.');
                                                return;
                                            }
                                            currentEditSelectedReturnDate = clickedDate;
                                            editReturnDate.value = clickedDate.toLocaleDateString('pl-PL');
                                        }
                                        calendarModal.style.display = 'none';
                                    });

                                    if (currentEditSelectedDepartureDate && cellDate.toDateString() === currentEditSelectedDepartureDate.toDateString()) {
                                        cell.classList.add('selected');
                                    } else if (currentEditSelectedReturnDate && cellDate.toDateString() === currentEditSelectedReturnDate.toDateString()) {
                                        cell.classList.add('selected');
                                    }
                                }
                                date++;
                            }
                            row.appendChild(cell);
                        }
                        tbody.appendChild(row);
                        if (date > daysInMonth) break;
                    }
                    table.appendChild(tbody);
                    calendarContainer.appendChild(table);
                }

                // Nawigacja dropdown (powielona z index.html)
                const languageIcon = document.getElementById('language-icon');
                const languageDropdown = document.getElementById('language-dropdown');
                const currencyIcon = document.getElementById('currency-icon');
                const currencyDropdown = document.getElementById('currency-dropdown');
                const accountIcon = document.getElementById('account-icon');
                const accountDropdown = document.getElementById('account-dropdown');

                function toggleDropdown(dropdownElement) {
                    document.querySelectorAll('.dropdown-content').forEach(dropdown => {
                        if (dropdown !== dropdownElement && dropdown.classList.contains('show')) {
                            dropdown.classList.remove('show');
                        }
                    });
                    dropdownElement.classList.toggle('show');
                }

                if (languageIcon) {
                    languageIcon.addEventListener('click', (event) => {
                        event.stopPropagation();
                        toggleDropdown(languageDropdown);
                    });
                }
                if (currencyIcon) {
                    currencyIcon.addEventListener('click', (event) => {
                        event.stopPropagation();
                        toggleDropdown(currencyDropdown);
                    });
                }
                if (accountIcon) {
                    accountIcon.addEventListener('click', (event) => {
                        event.stopPropagation();
                        toggleDropdown(accountDropdown);
                    });
                }

                document.addEventListener('click', (event) => {
                    if (languageDropdown && languageDropdown.classList.contains('show') && !languageDropdown.contains(event.target) && event.target !== languageIcon) {
                        languageDropdown.classList.remove('show');
                    }
                    if (currencyDropdown && currencyDropdown.classList.contains('show') && !currencyDropdown.contains(event.target) && event.target !== currencyIcon) {
                        currencyDropdown.classList.remove('show');
                    }
                    if (accountDropdown && accountDropdown.classList.contains('show') && !accountDropdown.contains(event.target) && event.target !== accountIcon) {
                        accountDropdown.classList.remove('show');
                    }
                    if (event.target.classList.contains('modal')) {
                        event.target.style.display = 'none';
                    }
                });

                document.querySelectorAll('.close-button').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const modalId = event.target.dataset.modal;
                        document.getElementById(modalId).style.display = 'none';
                    });
                });
            }

            // Obsługa przycisków przewijania dat w sliderze
            document.getElementById('prev-departure-day').addEventListener('click', () => {
                const firstDateElement = departureDateList.children[0];
                if (firstDateElement) {
                    const firstDate = new Date(firstDateElement.dataset.date);
                    firstDate.setDate(firstDate.getDate() - 7); // Przewiń o 7 dni wstecz
                    renderDateSlider(firstDate, departureDateList, 'departure', (selectedDateStr) => {
                         currentDepartureDate = formatDate(selectedDateStr);
                         renderFlights(selectedDateStr, 'departure', departureFlightListings, noDepartureFlightsMessage, departureClassRestrictionMessage);
                    });
                }
            });

            document.getElementById('next-departure-day').addEventListener('click', () => {
                const lastDateElement = departureDateList.children[departureDateList.children.length - 1];
                if (lastDateElement) {
                    const lastDate = new Date(lastDateElement.dataset.date);
                    lastDate.setDate(lastDate.getDate() + 7); // Przewiń o 7 dni w przód
                    renderDateSlider(lastDate, departureDateList, 'departure', (selectedDateStr) => {
                         currentDepartureDate = formatDate(selectedDateStr);
                         renderFlights(selectedDateStr, 'departure', departureFlightListings, noDepartureFlightsMessage, departureClassRestrictionMessage);
                    });
                }
            });

            // Te same przyciski dla powrotu, jeśli są widoczne
            if (document.getElementById('prev-return-day')) {
                document.getElementById('prev-return-day').addEventListener('click', () => {
                    const firstDateElement = returnDateList.children[0];
                    if (firstDateElement) {
                        const firstDate = new Date(firstDateElement.dataset.date);
                        firstDate.setDate(firstDate.getDate() - 7);
                        renderDateSlider(firstDate, returnDateList, 'return', (selectedDateStr) => {
                             currentReturnDate = formatDate(selectedDateStr);
                             renderFlights(selectedDateStr, 'return', returnFlightListings, noReturnFlightsMessage, returnClassRestrictionMessage);
                        });
                    }
                });
            }

            if (document.getElementById('next-return-day')) {
                document.getElementById('next-return-day').addEventListener('click', () => {
                    const lastDateElement = returnDateList.children[returnDateList.children.length - 1];
                    if (lastDateElement) {
                        const lastDate = new Date(lastDateElement.dataset.date);
                        lastDate.setDate(lastDate.getDate() + 7);
                        renderDateSlider(lastDate, returnDateList, 'return', (selectedDateStr) => {
                             currentReturnDate = formatDate(selectedDateStr);
                             renderFlights(selectedDateStr, 'return', returnFlightListings, noReturnFlightsMessage, returnClassRestrictionMessage);
                        });
                    }
                });
            }
        });
    </script>
</body>
</html>
